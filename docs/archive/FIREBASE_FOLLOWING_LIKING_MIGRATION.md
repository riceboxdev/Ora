# Firebase Following and Liking System Migration

## Overview
Migrated the following and liking system from Stream to Firebase Firestore. All follow relationships, likes, and comments are now stored directly in Firestore.

## Changes Made

### 1. Following System
- **Removed**: Stream follow calls (`setupStreamFollow`, `removeStreamFollow`)
- **Updated**: `ProfileService.swift` - now uses only Firestore for follows
- **Collection**: `follows/{followId}` where `followId = "{followerId}_{followingId}"`
- **Structure**:
  ```swift
  {
    followerId: String,
    followingId: String,
    createdAt: Timestamp
  }
  ```

### 2. Liking System
- **Created**: `LikeService.swift` - new Firebase-based like service
- **Collection**: `likes/{likeId}` where `likeId = "{postId}_{userId}"`
- **Structure**:
  ```swift
  {
    postId: String,
    userId: String,
    createdAt: Timestamp
  }
  ```

### 3. Comments System
- **Created**: `CommentService.swift` - new Firebase-based comment service
- **Collection**: `comments/{commentId}` (auto-generated document ID)
- **Structure**:
  ```swift
  {
    postId: String,
    userId: String,
    text: String,
    createdAt: Timestamp,
    updatedAt: Timestamp
  }
  ```

### 4. EngagementService Updates
- **Removed**: All Stream/Cloud Function dependencies
- **Updated**: All methods now use `LikeService` and `CommentService`
- **Changed Method Signatures**:
  - `commentOnPost(postId: String, text: String)` - removed `activityId`, `feedGroup`, `feedId`
  - `getComments(postId: String)` - removed `activityId`, `feedGroup`, `feedId`
  - `getLikeCount(postId: String)` - changed from `activityId` to `postId`
  - `getCommentCount(postId: String)` - changed from `activityId` to `postId`
  - `hasLiked(postId: String)` - changed from `activityId` to `postId`, removed `feedGroup`, `feedId`
  - `likePost(postId: String)` - changed from `activityId` to `postId`, removed `feedGroup`, `feedId`
  - `unlikePost(postId: String)` - changed from `activityId` to `postId`, removed `reactionId`, `feedGroup`, `feedId`

### 5. Firestore Rules
Added security rules for:
- **Likes collection**: Users can create likes, delete their own likes
- **Comments collection**: Users can create/update/delete their own comments

## Migration Steps

### 1. Deploy Firestore Rules
```bash
firebase deploy --only firestore:rules
```

### 2. Update iOS App Code
All views and view models that use `EngagementService` need to be updated:
- Change `activityId` parameters to `postId`
- Remove `feedGroup` and `feedId` parameters
- Remove `reactionId` parameter from `unlikePost`

### 3. Update Post Model
The `Post` model should fetch like/comment counts from Firestore when loading posts. You can either:
- Add computed properties that fetch counts on demand
- Include counts in the post document (requires updating counts on like/comment changes)

## API Changes

### Before (Stream-based)
```swift
// Like a post
try await engagementService.likePost(
    activityId: post.activityId,
    feedGroup: "user",
    feedId: post.userId
)

// Comment on a post
try await engagementService.commentOnPost(
    activityId: post.activityId,
    feedGroup: "user",
    feedId: post.userId,
    text: "Great post!"
)
```

### After (Firebase-based)
```swift
// Like a post
try await engagementService.likePost(postId: post.id)

// Comment on a post
try await engagementService.commentOnPost(
    postId: post.id,
    text: "Great post!"
)
```

## Next Steps

1. **Update View Models**: Update `PostDetailViewModel` and other view models to use new API
2. **Update Views**: Update UI components to pass `postId` instead of `activityId`
3. **Remove Stream Like Methods**: Remove `addLike`, `removeLike`, `hasLiked` from `StreamService`
4. **Test**: Test following, liking, and commenting functionality

## Notes

- Like IDs are deterministic: `"{postId}_{userId}"` - this prevents duplicate likes
- Comment IDs are auto-generated by Firestore
- All timestamps use `FieldValue.serverTimestamp()` for consistency
- Follow relationships already existed in Firestore, just removed Stream sync calls












